<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EvenTiamo â€“ QR Scanner</title>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<style>
    body {
        background:#0A0A0A;
        margin:0;
        padding:0;
        font-family: 'Inter', Arial, sans-serif;
        color:white;
        overflow-x:hidden;
    }
    .topbar {
        width:100%;
        padding:15px;
        text-align:center;
        background:#111;
        font-size:20px;
        font-weight:600;
        color:gold;
        box-shadow:0 0 10px rgba(0,0,0,0.5);
        position:sticky;
        top:0;
        z-index:99;
    }
    #reader {
        width:100%;
        max-width:360px;
        margin:25px auto 10px auto;
        border-radius:12px;
        overflow:hidden;
        box-shadow:0px 0px 20px rgba(255,255,255,0.15);
    }
    .field {
        width:90%;
        max-width:340px;
        padding:14px;
        border-radius:10px;
        border:1px solid #333;
        background:#000;
        color:white;
        font-size:16px;
        margin:10px auto;
        display:block;
    }
    .btn {
        width:90%;
        max-width:340px;
        padding:14px;
        background:gold;
        color:black;
        border:none;
        border-radius:10px;
        font-size:17px;
        font-weight:bold;
        margin:10px auto;
        display:block;
        cursor:pointer;
    }
    #result {
        margin:20px auto;
        width:90%;
        max-width:340px;
        padding:18px;
        border-radius:12px;
        font-size:18px;
        text-align:center;
        display:none;
    }
</style>
</head>

<body>

<div class="topbar">ðŸŽ« EvenTiamo Check-In</div>

<div id="reader"></div>

<input id="ticketId" class="field" placeholder="Enter Ticket ID manually">
<button class="btn" onclick="checkTicket()">Check In</button>

<div id="result"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwCV1SOuJRTO_TddxYMJ5eMBR38GZG215UoU2A9xdH-xOdAwEZtkZFvGdddBE-fC7Rl6w/exec";

window.onload = async function () {
    let qrBoxSize = Math.min(window.innerWidth * 0.75, 280);
    const scanner = new Html5Qrcode("reader");

    // Force camera permission popup
    try {
        await navigator.mediaDevices.getUserMedia({ video: true });
    } catch (e) {
        alert("Please allow camera permission to scan QR codes.");
    }

    scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: qrBoxSize },
        (qrMessage) => {
            let cleanTicket = qrMessage;
            if (qrMessage.includes("ticket=")) {
                cleanTicket = qrMessage.split("ticket=")[1].trim();
            }
            checkTicket(cleanTicket);
        },
        (err) => {}
    ).catch(err => {
        alert("Camera access blocked. Please enable camera permissions in your browser settings.");
        console.log(err);
    });
};

async function checkTicket(autoVal = null) {
    const ticket = autoVal || document.getElementById("ticketId").value.trim();
    const box = document.getElementById("result");

    if (!ticket) return alert("Enter Ticket ID");

    box.style.display = "block";
    box.style.background = "#222";
    box.textContent = "Checkingâ€¦";

    try {
        const res = await fetch(API_URL + "?ticket=" + ticket);
        const data = await res.json();

        if (!data.success) {
            box.style.background = "#7a0000";
            box.textContent = "âŒ " + (data.msg || data.error || "Invalid Ticket");
            setTimeout(() => { box.style.display = "none"; }, 8000);
            return;
        }

        box.style.background = "#004d00";
        box.textContent = "âœ… Check-In Successful!";
        setTimeout(() => { box.style.display = "none"; }, 8000);

    } catch (err) {
        box.style.background = "#7a0000";
        box.textContent = "âŒ Network Error";
        setTimeout(() => { box.style.display = "none"; }, 8000);
    }
}
</script>

</body>
</html>
